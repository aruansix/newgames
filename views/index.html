<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>NewGames</title>
    <link rel="stylesheet" href="/views/style.css">
</head>
<body>

<header>
    <h1>NewGames</h1>
    <div id="userActions" style="display: inline-block; margin-left: 20px;"></div>
    <a href="/login" id="loginBtn">
        <button>Login</button>
    </a>
</header>

<main>
    <h2>Jogos disponíveis</h2>
    <div id="listaJogos" class="lista-jogos"></div>
    
    <div id="formAnunciar" style="display:none; margin-top:20px;"></div>
    <div id="adminPainel" style="display:none; margin-top:20px;"></div>
    <div id="historicoComprador" style="margin-top:20px;"></div>
    <div id="historicoVendedor" style="margin-top:20px;"></div>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const lista = document.getElementById("listaJogos");
    const loginBtn = document.getElementById("loginBtn");
    const userActions = document.getElementById("userActions");
    const formAnunciarDiv = document.getElementById("formAnunciar");
    const adminPainelDiv = document.getElementById("adminPainel");
    const historicoCompradorDiv = document.getElementById("historicoComprador");
    const historicoVendedorDiv = document.getElementById("historicoVendedor");

    const usuario = JSON.parse(sessionStorage.getItem("usuario"));

    async function carregarJogos() {
        const res = await fetch("/jogos");
        const jogos = await res.json();

        lista.innerHTML = jogos.map(j => {
            let botaoComprar = "";
            if (usuario && usuario.tipo === "comprador" && j.aprovado) {
                botaoComprar = `<button onclick="comprarJogo('${j.titulo}')">Comprar</button>`;
            }
            return `
                <div class="jogo">
                    <h3>${j.titulo}</h3>
                    <span>Preço: R$ ${j.preco.toFixed(2)}</span>
                    <span>Plataforma: ${j.plataforma}</span>
                    <span>Estado: ${j.estado}</span>
                    ${botaoComprar}
                </div>
            `;
        }).join("");
    }

    window.comprarJogo = async function(titulo) {
        try {
            const res = await fetch("/comprar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ emailComprador: usuario.email, titulo })
            });
            const data = await res.json();
            if (res.ok) {
                alert(data.mensagem);
                carregarJogos();
            } else {
                alert(data.erro);
            }
        } catch (err) {
            console.error(err);
            alert("Erro ao comprar o jogo.");
        }
    };

    if (usuario) {
        loginBtn.style.display = "none";
        userActions.innerHTML = `Logado como: <strong>${usuario.nome}</strong> (${usuario.tipo})`;

        const btnSair = document.createElement("button");
        btnSair.textContent = "Sair";
        btnSair.style.marginLeft = "10px";
        btnSair.onclick = () => {
            sessionStorage.removeItem("usuario");
            window.location.reload();
        };
        userActions.appendChild(btnSair);

        if (usuario.tipo === "comprador") {
            const btnCompras = document.createElement("button");
            btnCompras.textContent = "Meus Pedidos";
            btnCompras.onclick = async () => {
                try {
                    const res = await fetch(`/comprador/pedidos/${usuario.email}`);
                    const pedidos = await res.json();

                    historicoCompradorDiv.innerHTML = "";
                    if (pedidos.length === 0) {
                        historicoCompradorDiv.innerHTML = "<p>Você ainda não comprou nenhum jogo.</p>";
                        return;
                    }

                    let listaPedidos = "<h3>Meus Pedidos:</h3><ul>";
                    pedidos.forEach(p => {
                        listaPedidos += `<li>${p.titulo} - R$ ${p.preco.toFixed(2)} (${p.plataforma})</li>`;
                    });
                    listaPedidos += "</ul>";
                    historicoCompradorDiv.innerHTML = listaPedidos;

                } catch (err) {
                    console.error("Erro ao carregar pedidos:", err);
                }
            };
            userActions.appendChild(btnCompras);
        } 
        else if (usuario.tipo === "vendedor") {
            const btnAnunciar = document.createElement("button");
            btnAnunciar.textContent = "Anunciar Novo Jogo";
            btnAnunciar.onclick = () => {
                formAnunciarDiv.style.display = "block";
                formAnunciarDiv.innerHTML = `
                    <h3>Anunciar Jogo</h3>
                    <form id="anunciarForm">
                        <p><label>Título</label><br><input type="text" name="titulo" required></p>
                        <p><label>Preço</label><br><input type="number" step="0.01" name="preco" required></p>
                        <p><label>Plataforma</label><br><input type="text" name="plataforma" required></p>
                        <p><label>Estado</label><br>
                            <select name="estado" required>
                                <option value="Novo">Novo</option>
                                <option value="Usado">Usado</option>
                            </select>
                        </p>
                        <button type="submit">Anunciar</button>
                    </form>
                `;
                const anunciarForm = document.getElementById("anunciarForm");
                anunciarForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const formData = new FormData(anunciarForm);
                    const jogo = {
                        titulo: formData.get("titulo"),
                        preco: parseFloat(formData.get("preco")),
                        plataforma: formData.get("plataforma"),
                        estado: formData.get("estado"),
                        emailVendedor: usuario.email
                    };
                    try {
                        const res = await fetch("/anunciar", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(jogo)
                        });
                        const data = await res.json();
                        if (res.ok) {
                            alert(data.mensagem);
                            carregarJogos();
                            anunciarForm.reset();
                            formAnunciarDiv.style.display = "none";
                        } else {
                            alert(data.erro);
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Erro ao anunciar o jogo.");
                    }
                });
            };
            userActions.appendChild(btnAnunciar);

            const btnMeusAnuncios = document.createElement("button");
            btnMeusAnuncios.textContent = "Meus Anúncios";
            btnMeusAnuncios.onclick = async () => {
                try {
                    const res = await fetch(`/vendedor/anuncios/${usuario.email}`);
                    const anuncios = await res.json();

                    historicoVendedorDiv.innerHTML = "";
                    if (anuncios.length === 0) {
                        historicoVendedorDiv.innerHTML = "<p>Você ainda não anunciou nenhum jogo.</p>";
                        return;
                    }

                    let listaAnuncios = "<h3>Meus Anúncios:</h3><ul>";
                    anuncios.forEach(j => {
                        listaAnuncios += `<li>${j.titulo} - R$ ${j.preco.toFixed(2)} (${j.plataforma}) - ${j.estado} - ${j.aprovado ? "Aprovado" : "Não aprovado"}</li>`;
                    });
                    listaAnuncios += "</ul>";
                    historicoVendedorDiv.innerHTML = listaAnuncios;

                } catch (err) {
                    console.error("Erro ao carregar anúncios:", err);
                }
            };
            userActions.appendChild(btnMeusAnuncios);
        } 
        else if (usuario.tipo === "admin") {
            const btnAdmin = document.createElement("button");
            btnAdmin.textContent = "Painel Admin";
            btnAdmin.onclick = async () => {
                adminPainelDiv.style.display = "block";
                const res = await fetch("/admin/jogos");
                const jogos = await res.json();
                adminPainelDiv.innerHTML = "<h3>Painel de Aprovação</h3>" + jogos.map(j => `
                    <div class="jogo">
                        <h3>${j.titulo}</h3>
                        <span>Preço: R$ ${j.preco.toFixed(2)}</span>
                        <span>Plataforma: ${j.plataforma}</span>
                        <span>Estado: ${j.estado}</span>
                        <button onclick="alterarAprovacao('${j.titulo}', true)">Aprovar</button>
                        <button onclick="alterarAprovacao('${j.titulo}', false)">Reprovar</button>
                    </div>
                `).join("");
            };
            userActions.appendChild(btnAdmin);
        }
    }

    window.alterarAprovacao = async function(titulo, aprovado) {
        try {
            const res = await fetch("/admin/jogo", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ emailAdmin: usuario.email, titulo, aprovado })
            });
            const data = await res.json();
            if (res.ok) {
                alert(data.mensagem);
                document.getElementById("adminPainel").click();
                carregarJogos();
            } else {
                alert(data.erro);
            }
        } catch (err) {
            console.error(err);
            alert("Erro ao alterar aprovação.");
        }
    };

    carregarJogos();
});
</script>

</body>
</html>